# Mawster — AI Context

> Alliance management tool for **Marvel Contest of Champions** (MCoC).
> School project (CESI) — formerly named "Cesi Zen".

---

## 1. Tech Stack

| Layer | Technology | Version / Notes |
|-------|-----------|-----------------|
| **Backend** | FastAPI + SQLModel | Python 3.12, async, Pydantic v2 |
| **ORM / DB** | SQLModel + aiomysql | Async MariaDB driver |
| **Migrations** | Alembic | `api/migrations/` |
| **Auth** | Discord OAuth2 → NextAuth → backend JWT | PyJWT, HS256 |
| **Frontend** | Next.js (App Router) | v16+ with Turbopack |
| **UI** | Tailwind CSS + shadcn/ui | Radix primitives |
| **i18n** | Custom React Context | `front/app/i18n/` — EN (default), FR |
| **Forms** | react-hook-form + Zod | |
| **Docker** | Docker Compose | MariaDB, API, Front, Caddy, PHPMyAdmin, Watchtower |
| **Reverse Proxy** | Caddy | `/api/back/*` → API, `/phpmyadmin/*` → PMA, `/*` → Front |

---

## 2. Project Structure

```
Cesi_Zen/
├── api/                         # FastAPI backend
│   ├── main.py                  # App entry, routers, middleware
│   ├── src/
│   │   ├── controllers/         # APIRouter modules
│   │   │   ├── admin_controller.py
│   │   │   ├── auth_controller.py
│   │   │   ├── user_controller.py
│   │   │   ├── game_account_controller.py
│   │   │   ├── alliance_controller.py
│   │   │   └── champion_user_controller.py
│   │   ├── dto/                 # Pydantic request/response schemas
│   │   ├── enums/               # Roles, AuthProvider
│   │   ├── fixtures/            # DB seed scripts (reset, sample, champion init)
│   │   ├── Messages/            # Validation/error message constants
│   │   ├── models/              # SQLModel table classes
│   │   ├── security/            # secrets.py (Settings from env)
│   │   ├── services/            # Business logic (stateless class methods)
│   │   ├── utils/               # db.py (engine, session), helpers
│   │   └── validators/          # Custom validation logic
│   ├── migrations/              # Alembic versions
│   └── tests/                   # pytest (unit + integration)
├── front/                       # Next.js frontend
│   ├── app/
│   │   ├── layout.tsx           # Root layout (SideNavBar + Providers)
│   │   ├── page.tsx             # Landing page
│   │   ├── providers.tsx        # SessionProvider, ThemeProvider, I18nProvider
│   │   ├── api/                 # Next.js API routes (auth, proxy)
│   │   ├── dashboard/           # Admin dashboard pages
│   │   ├── game/                # Game accounts & alliances pages
│   │   ├── login/ & register/   # Auth pages
│   │   ├── profile/             # User profile pages
│   │   ├── i18n/                # I18n context, EN/FR locale files
│   │   ├── lib/                 # auth.ts, constants.ts, utils, apiClient
│   │   ├── services/            # Frontend service layer (users.ts, game.ts)
│   │   ├── types/               # TypeScript interfaces
│   │   └── ui/                  # Fonts, global CSS, stylesheets only
│   ├── components/
│   │   ├── ui/                  # shadcn/ui primitives ONLY (20 files)
│   │   ├── confirmation-dialog.tsx  # Reusable confirmation dialog (wraps AlertDialog + i18n)
│   │   ├── CesiZenLogo.tsx      # Legacy logo component
│   │   ├── MawsterLogo.tsx      # Main logo component
│   │   ├── language-switcher.tsx # EN/FR language toggle
│   │   ├── left-nav-bar/        # SideNavBar + NavLinks (role-based)
│   │   ├── dashboard/           # Admin dashboard components
│   │   │   ├── actions/         # User action dropdown + dialogs
│   │   │   ├── pagination/      # Pagination controls, page selector, dropdown
│   │   │   └── table/           # User table: header, rows, cells, renderer
│   │   └── users/               # User avatar bubble
│   ├── hooks/                   # Custom React hooks
│   ├── middleware.ts            # Auth guard (public routes, admin routes)
│   └── public/                  # Static assets
├── Docs/                        # PlantUML diagrams, guides
├── compose.yaml                 # Production Docker Compose
├── compose-dev.yaml             # Dev overrides
├── Caddyfile                    # Reverse proxy config
└── db.env                       # MariaDB credentials
```

---

## 3. Database Models

### User (PK: uuid)
`login` (unique), `email` (unique), `discord_id` (unique, indexed), `avatar_url`, `role` (enum: ADMIN/USER), `disabled_at`, `deleted_at`, `created_at`, `last_login_date`
→ has many `LoginLog`, `GameAccount`

### LoginLog
`date_connexion`, `id_user` (FK → User)

### Alliance
`name` (max 100), `tag` (max 10), `description`, `owner_id` (FK → GameAccount, NOT NULL), `created_at`
→ has one `owner` (GameAccount), many `members` (GameAccount via alliance_id), many `adjoints` (AllianceAdjoint)

### AllianceAdjoint (join table)
`alliance_id` (FK → Alliance), `game_account_id` (FK → GameAccount), `assigned_at`
→ belongs to Alliance, GameAccount — represents deputy members designated by the alliance owner

### GameAccount
`user_id` (FK → User), `alliance_id` (FK → Alliance, nullable), `game_pseudo` (max 50), `is_primary`, `created_at`
→ belongs to User, Alliance; has many `ChampionUser` (roster); optional `owned_alliance`, many `adjoint_entries`

### Champion
`name` (max 100), `champion_class` (max 20), `image_url`, `is_7_star`
→ has many `ChampionUser` (instances)

### ChampionUser
`game_account_id` (FK → GameAccount), `champion_id` (FK → Champion), `stars`, `rank`, `level`, `signature`
→ belongs to GameAccount, Champion

---

## 4. Auth Flow

1. User clicks "Login with Discord" on frontend
2. NextAuth initiates Discord OAuth2 flow
3. On success, NextAuth receives Discord `access_token`
4. Frontend POSTs `access_token` to `POST /auth/discord`
5. Backend verifies token against Discord API (`GET /users/@me`)
6. Backend creates or finds user by `discord_id`
7. Backend returns a signed JWT (HS256, `SECRET_KEY`)
8. Frontend stores JWT in NextAuth session, sends it as `Authorization: Bearer <token>` on API calls

---

## 5. API Endpoints

| Prefix | Controller | Description |
|--------|-----------|-------------|
| `/auth` | auth_controller | Discord login, session check |
| `/admin` | admin_controller | Admin-only user management |
| `/users` | user_controller | User profile operations |
| `/game-accounts` | game_account_controller | CRUD game accounts |
| `/alliances` | alliance_controller | CRUD alliances + adjoint management (`POST/DELETE /{id}/adjoints`) |
| `/champion-users` | champion_user_controller | CRUD champion roster entries |

All game endpoints require authentication. Ownership is verified (user can only modify their own resources).

---

## 6. Conventions & Patterns

### Backend
- **Async everywhere**: all DB operations use `await`, sessions are `AsyncSession`
- **Service pattern**: controllers delegate to stateless service classes (e.g. `GameAccountService`, `AuthService`)
- **DTOs**: Pydantic `BaseModel` for request/response schemas in `src/dto/`
- **Auth dependency**: `AuthService.get_current_user_in_jwt` via `Depends()` — decodes JWT from `Authorization` header
- **Error handling**: raise `HTTPException` with proper status codes
- **Env config**: `src/security/secrets.py` loads from `api.env` via pydantic `BaseSettings`

### Frontend
- **App Router** (Next.js): pages in `app/`, layouts via `layout.tsx`
- **shadcn/ui**: primitives in `components/ui/` (ONLY shadcn files), custom app components in `components/` subdirectories
- **Custom components**: `components/left-nav-bar/`, `components/dashboard/`, `components/users/`, `components/confirmation-dialog.tsx`, logos, language-switcher
- **i18n**: `useI18n()` hook returns `{ t, locale, setLocale }` — translations in `app/i18n/locales/{en,fr}.ts`
- **API calls**: use `apiClient` from `app/lib/apiClient` which attaches the JWT
- **Auth guard**: `middleware.ts` protects routes, redirects unauthenticated users
- **Theming**: `next-themes` for dark/light mode

### General
- **Language**: backend code and comments in English (some French in older code)
- **Docker images**: pushed to `sneaxiii/mawster-api` and `sneaxiii/mawster-front` on Docker Hub
- **Auto-deploy**: Watchtower polls every 300s for new images
- **No ORM lazy loading**: relationships must be explicitly loaded with `selectinload()` (async SQLModel limitation)

---

## 7. Useful Commands

```bash
# Backend (from api/)
pip install -r requirements.txt       # Install deps
uvicorn main:app --reload --host 0.0.0.0 --port 8000  # Run dev server
alembic upgrade head                  # Apply migrations
alembic revision --autogenerate -m "description"  # Create migration
python -m pytest tests/               # Run tests

# Frontend (from front/)
npm install                           # Install deps
npm run dev                           # Dev server (Turbopack)
npm run build && npm run start        # Production build

# Docker
docker compose up -d                  # Start all services
docker compose -f compose-dev.yaml up -d  # Dev compose
docker compose logs -f api            # Tail API logs
```

---

## 8. Environment Variables

### api.env
`MODE`, `MARIADB_DATABASE`, `MARIADB_USER`, `MARIADB_PASSWORD`, `MARIADB_ROOT_PASSWORD`, `MARIADB_HOST`, `MARIADB_PORT`, `SECRET_KEY`, `ALGORITHM`, `ACCESS_TOKEN_EXPIRE_MINUTES`

### front.env
`NEXTAUTH_SECRET`, `NEXTAUTH_URL`, `DISCORD_CLIENT_ID`, `DISCORD_CLIENT_SECRET`, `NEXT_PUBLIC_API_URL`

### db.env
`MARIADB_DATABASE`, `MARIADB_USER`, `MARIADB_PASSWORD`, `MARIADB_ROOT_PASSWORD`
